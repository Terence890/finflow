{% extends "base.html" %}
{% block title %}Dashboard - PinkLedger{% endblock %}

{% block content %}
<div class="cards">
  <div class="card stat-card">
    <div class="stat-row">
      <div>
        <div class="title">Balance</div>
        <div class="value">₱ {{ balance or 0 }}</div>
      </div>
      <div class="stat-icon" aria-hidden="true">
        <svg viewBox="0 0 24 24">
          <path d="M4 12h16" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
          <path d="M7 8h10M7 16h6" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
        </svg>
      </div>
    </div>
  </div>
  <div class="card stat-card">
    <div class="stat-row">
      <div>
        <div class="title">Total Income</div>
        <div class="value">₱ {{ total_income or 0 }}</div>
      </div>
      <div class="stat-icon" aria-hidden="true">
        <svg viewBox="0 0 24 24">
          <path d="M12 4v12" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
          <path d="M7 11l5 5 5-5" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
    </div>
  </div>
  <div class="card stat-card">
    <div class="stat-row">
      <div>
        <div class="title">Total Expense</div>
        <div class="value">₱ {{ total_expense or 0 }}</div>
      </div>
      <div class="stat-icon" aria-hidden="true">
        <svg viewBox="0 0 24 24">
          <path d="M12 20V8" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
          <path d="M17 13l-5-5-5 5" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
    </div>
  </div>
</div>

<div class="charts">
  <div class="chart-card">
    <div class="chart-header">
      <div class="chart-title">
        <span class="chart-icon" aria-hidden="true">
          <svg viewBox="0 0 24 24">
            <path d="M12 4v8l6 6" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
            <path d="M12 4a8 8 0 1 0 8 8" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
          </svg>
        </span>
        <h3>Expense by Category</h3>
      </div>
      <span class="chart-pill">Live</span>
    </div>
    <canvas id="expensePie" height="220"></canvas>
    <div class="chart-legend" data-category-legend></div>
  </div>
  <div class="chart-card">
    <div class="chart-header">
      <div class="chart-title">
        <span class="chart-icon" aria-hidden="true">
          <svg viewBox="0 0 24 24">
            <path d="M12 5v14M5 12h14" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
          </svg>
        </span>
        <h3>Quick Add</h3>
      </div>
      <span class="chart-pill soft">Fast entry</span>
    </div>
    <div class="form">
      <form method="post" action="{{ url_for('finance.add_income') }}">
        {{ csrf_token() if csrf_token is defined }}
        <label>Amount</label>
        <input class="input" type="number" name="amount" step="0.01" required>
        <label>Source</label>
        <input class="input" type="text" name="source" required>
        <label>Date</label>
        <input class="input" type="date" name="date" value="{{ today }}" required>
        <button class="btn btn-primary" type="submit">Add Income</button>
      </form>
    </div>
    <div class="form">
      <form method="post" action="{{ url_for('finance.add_expense') }}">
        {{ csrf_token() if csrf_token is defined }}
        <label>Amount</label>
        <input class="input" type="number" name="amount" step="0.01" required>
        <label>Category</label>
        <div class="category-grid" role="radiogroup" aria-label="Expense category">
          <label class="category-option">
            <input type="radio" name="category" value="Food" required>
            <span class="category-icon" aria-hidden="true">
              <svg viewBox="0 0 24 24">
                <path d="M7 3v9M11 3v9M15 4v8" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
                <path d="M6 12h10v5a3 3 0 0 1-3 3H9a3 3 0 0 1-3-3z" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/>
                <path d="M18 9c2 0 2 3 0 3" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
              </svg>
            </span>
            <span class="category-label">Food</span>
          </label>
          <label class="category-option">
            <input type="radio" name="category" value="Travel">
            <span class="category-icon" aria-hidden="true">
              <svg viewBox="0 0 24 24">
                <path d="M3 12h18" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
                <path d="M5 12l3-6h8l3 6" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/>
                <path d="M7 12l2 7M17 12l-2 7" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
              </svg>
            </span>
            <span class="category-label">Travel</span>
          </label>
          <label class="category-option">
            <input type="radio" name="category" value="Shopping">
            <span class="category-icon" aria-hidden="true">
              <svg viewBox="0 0 24 24">
                <path d="M6 8h12l-1.2 10.5a2 2 0 0 1-2 1.5H9.2a2 2 0 0 1-2-1.5z" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/>
                <path d="M9 8a3 3 0 0 1 6 0" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
              </svg>
            </span>
            <span class="category-label">Shopping</span>
          </label>
          <label class="category-option">
            <input type="radio" name="category" value="Bills">
            <span class="category-icon" aria-hidden="true">
              <svg viewBox="0 0 24 24">
                <path d="M6 3h9l3 3v15H6z" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/>
                <path d="M9 11h6M9 15h6" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
              </svg>
            </span>
            <span class="category-label">Bills</span>
          </label>
          <label class="category-option">
            <input type="radio" name="category" value="Others">
            <span class="category-icon" aria-hidden="true">
              <svg viewBox="0 0 24 24">
                <path d="M12 4v16M4 12h16" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
                <path d="M7 7l10 10" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
              </svg>
            </span>
            <span class="category-label">Others</span>
          </label>
        </div>
        <label>Date</label>
        <input class="input" type="date" name="date" value="{{ today }}" required>
        <button class="btn btn-secondary" type="submit">Add Expense</button>
      </form>
    </div>
  </div>
</div>

<div class="card">
  <h3>Recent Income</h3>
  <table class="table">
    <thead>
      <tr>
        <th>Date</th>
        <th>Source</th>
        <th>Amount</th>
      </tr>
    </thead>
    <tbody>
      {% for inc in incomes %}
      <tr>
        <td>{{ inc.date }}</td>
        <td>{{ inc.source or 'Income' }}</td>
        <td>₱ {{ inc.amount }}</td>
      </tr>
      {% else %}
      <tr>
        <td colspan="3" class="muted">No income yet</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div class="card">
  <h3>Recent Expenses</h3>
  <table class="table">
    <thead>
      <tr>
        <th>Date</th>
        <th>Category</th>
        <th>Amount</th>
      </tr>
    </thead>
    <tbody>
      {% for exp in expenses %}
      <tr>
        <td>{{ exp.date }}</td>
        <td>{{ exp.category or 'Other' }}</td>
        <td>₱ {{ exp.amount }}</td>
      </tr>
      {% else %}
      <tr>
        <td colspan="3" class="muted">No expenses yet</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
  const rawData = {{ expense_by_category | tojson | safe if expense_by_category is defined else '[]' }};
  const expenseData = Array.isArray(rawData) ? rawData : [];
  const colors = ['#FF5FA2', '#FFC1D9', '#FF2F7D', '#FFD6E8', '#FFEFF6'];
  const canvas = document.getElementById('expensePie');
  const legend = document.querySelector('[data-category-legend]');
  if (legend && window.PinkLedgerUI && typeof window.PinkLedgerUI.renderCategoryLegend === 'function') {
    window.PinkLedgerUI.renderCategoryLegend(legend, expenseData, colors);
  }
  if (typeof Chart !== 'undefined' && canvas) {
    const ctx = canvas.getContext('2d');
    new Chart(ctx, {
      type: 'pie',
      data: {
        labels: expenseData.map(e => e.category),
        datasets: [{
          data: expenseData.map(e => e.amount),
          backgroundColor: colors
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        aspectRatio: 1,
        animation: { duration: 800, easing: 'easeOutQuart' }
      }
    });
  }
});
</script>
{% endblock %}
